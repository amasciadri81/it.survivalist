#!/bin/bash
# v 1.0
# this script builds and sends a DHCP FORCERENEW packet
# it needs netcat and xxd installed
#


# USAGE
if [[ $# -ne 3 ]]; then
    echo "usage:"
    echo "      $0 <offer transaction id> <client ip> <client mac>"
    echo
    exit 2
fi


# SET ARGS
TRANSACTION_ID=$1
IP_ADDR=$2
CLIENT_MAC=$3


# CLEAN TRANSACTION ID
if [[ $(echo $TRANSACTION_ID | grep x) ]]; then
        TRANSACTION_ID=${TRANSACTION_ID#*0x}
fi
TRANSACTION_ID=${TRANSACTION_ID// /}
TRANSACTION_ID=$(echo -n $TRANSACTION_ID | sed 's/.\{2\}/& /g')


# CONVERT IP TO HEX
H_IP_ADDR=$(printf '%02x ' ${IP_ADDR//./ })

# CLEAN MAC
CLIENT_MAC=${CLIENT_MAC// /}
CLIENT_MAC=${CLIENT_MAC//:/}
CLIENT_MAC=${CLIENT_MAC//-/}
CLIENT_MAC=${CLIENT_MAC//./}
CLIENT_MAC=$(echo -n $CLIENT_MAC | sed 's/.\{2\}/& /g')


# DEFAULT PARAMETERS
MAGIC_COOKIE="63 82 53 63" # DHCP
OPTION_53="35 01 09"
END="ff"


# HEX
HEX="02 01 06 00 "$TRANSACTION_ID" 00 00 00 00 "$H_IP_ADDR$H_IP_ADDR"00 00 00 00 00 00 00 00 "$CLIENT_MAC" 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 "$MAGIC_COOKIE" "$OPTION_53" "$END" 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00"

# SEND
echo $HEX | tr [a-f] [A-F] | xxd -r -p | nc -w1 -u $IP_ADDR 67

# END
